<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVA Expense Reimbursement Portal</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/phosphor-icons"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .tab-active {
            border-bottom: 2px solid #0d9488; /* teal-600 */
            color: #0d9488; /* teal-600 */
            font-weight: 600;
        }
        .tab-content { display: none; }
        .tab-content-active { display: block; }

        /* Mobile Tab Wrapping */
        @media (max-width: 768px) {
            #main-nav-buttons {
                flex-wrap: wrap;
                justify-content: flex-start; /* Align wrapped tabs to the left */
            }
             #main-nav-buttons .tab-btn {
                 padding-left: 1rem; /* px-4 */
                 padding-right: 1rem; /* px-4 */
                 flex-grow: 1; /* Allow buttons to grow slightly if needed */
                 min-width: 120px; /* Ensure buttons don't get too small */
                 text-align: center;
             }
        }

        /* Basic modal styles */
        .modal { display: none; }
        .modal-active { display: flex; }

        /* Spinner for loading */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #0d9488; /* Teal */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive form layout */
        .form-grid {
             grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        /* Ensure file inputs look consistent */
         input[type="file"] {
            padding: 0.5rem; /* Add some padding */
         }
         input[type="file"]::-webkit-file-upload-button {
            margin-right: 0.5rem;
            border: 1px solid #cbd5e1; /* slate-300 */
            background: #f1f5f9; /* slate-100 */
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem; /* rounded-md */
            cursor: pointer;
            transition: background-color 0.2s;
         }
          input[type="file"]::-webkit-file-upload-button:hover {
             background: #e2e8f0; /* slate-200 */
          }

          /* Style for policy details */
          .policy-tier {
             border-left-width: 4px;
             padding-left: 1rem; /* pl-4 */
             margin-bottom: 1.5rem; /* mb-6 */
          }
           .policy-tier h4 { margin-bottom: 0.5rem; /* mb-2 */ }
           .policy-tier ul { margin-top: 0.75rem; /* mt-3 */ }
           .policy-tier li { margin-bottom: 0.5rem; /* mb-2 */ } /* Added margin between list items */
           .policy-tier .sub-list { list-style-type: circle; margin-left: 1rem; /* ml-4 */ font-size: 0.75rem; /* text-xs */ } /* Styling for nested lists */


    </style>
</head>
<body class="antialiased text-slate-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="loader"></div>
        <p class="ml-4 text-slate-600">Loading...</p>
    </div>

    <!-- Message Display Area -->
    <div id="message-container" class="fixed top-5 right-5 z-50 max-w-sm w-full">
        <!-- Messages appear here -->
    </div>

    <!-- Approval Modal -->
    <div id="approval-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 items-center justify-center p-4 z-40">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <h3 class="text-xl font-semibold mb-4 text-slate-800">Approval Action: <span id="modal-request-id"></span></h3>
            <p class="text-sm text-slate-600 mb-1">Submitter: <strong id="modal-submitter"></strong></p>
            <p class="text-sm text-slate-600 mb-1">Amount: <strong id="modal-amount"></strong></p>
            <p class="text-sm text-slate-600 mb-3">Description: <strong id="modal-description"></strong></p>
            <div>
                <label for="approval-comments" class="block text-sm font-medium text-slate-700">Comments (Required for Rejection)</label>
                <textarea id="approval-comments" rows="3" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500"></textarea>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="modal-cancel-btn" class="bg-slate-200 text-slate-800 font-medium py-2 px-4 rounded-lg hover:bg-slate-300 transition">Cancel</button>
                <button type="button" id="modal-reject-btn" data-decision="rejected" class="bg-red-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-red-700 transition">Reject</button>
                <button type="button" id="modal-approve-btn" data-decision="approved" class="bg-teal-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-teal-700 transition">Approve</button>
            </div>
        </div>
    </div>

    <!-- Check Issue Modal -->
    <div id="check-issue-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 items-center justify-center p-4 z-40">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4 text-slate-800">Mark as Paid: <span id="check-modal-request-id"></span></h3>
            <p class="text-sm text-slate-600 mb-3">Amount: <strong id="check-modal-amount"></strong> | Submitter: <strong id="check-modal-submitter"></strong></p>
            <div>
                <label for="check-number" class="block text-sm font-medium text-slate-700">Check Number / Transaction ID (Optional)</label>
                <input type="text" id="check-number" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500">
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="check-modal-cancel-btn" class="bg-slate-200 text-slate-800 font-medium py-2 px-4 rounded-lg hover:bg-slate-300 transition">Cancel</button>
                <button type="button" id="check-modal-confirm-btn" class="bg-teal-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-teal-700 transition">Confirm Payment</button>
            </div>
        </div>
    </div>


    <div class="min-h-screen bg-slate-50">
        <header class="bg-white shadow-sm sticky top-0 z-30">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <!-- Logo and Title -->
                    <div class="flex items-center">
                         <img src="https://raw.githubusercontent.com/bmns1/parent-portal/main/logo.png" alt="SVA Logo" class="h-10 w-auto mr-3">
                        <h1 class="text-xl font-bold text-slate-900 hidden sm:block">SVA Expense Reimbursement</h1>
                         <h1 class="text-lg font-bold text-slate-900 sm:hidden">SVA Expenses</h1>
                    </div>

                    <!-- Login/User Info -->
                    <div class="flex items-center">
                        <div id="user-info" class="hidden text-right mr-4">
                            <p class="text-sm font-medium text-slate-800" id="user-name"></p>
                            <p class="text-xs text-slate-500" id="user-email"></p>
                        </div>
                        <div id="google-signin-button" class="flex items-center">
                           <!-- Google Button Rendered Here -->
                           <span class="text-sm text-slate-600 mr-2 hidden md:inline">Approver Login:</span>
                        </div>
                        <button id="sign-out-button" onclick="handleSignOut();" class="hidden ml-4 bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition text-sm">Sign Out</button>
                    </div>
                </div>
            </div>
        </header>

        <nav class="bg-white border-b border-slate-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div id="main-nav-buttons" class="flex -mb-px">
                    <!-- Public Tabs -->
                    <button class="tab-btn tab-active text-slate-600 hover:text-teal-600 py-3 px-5 block focus:outline-none text-sm font-medium" data-tab="policy"><i class="ph-scroll mr-1"></i> Policy</button>
                    <button class="tab-btn text-slate-600 hover:text-teal-600 py-3 px-5 block focus:outline-none text-sm font-medium" data-tab="new-request"><i class="ph-note-pencil mr-1"></i> New Request</button>
                    <!-- <button class="tab-btn text-slate-600 hover:text-teal-600 py-3 px-5 block focus:outline-none text-sm font-medium" data-tab="check-status"><i class="ph-magnifying-glass mr-1"></i> Check Status</button> -->

                    <!-- Secure Tabs (Initially Hidden) -->
                    <button id="tab-btn-approvals" class="tab-btn text-slate-600 hover:text-teal-600 py-3 px-5 hidden focus:outline-none text-sm font-medium" data-tab="pending-approvals"><i class="ph-check-square-offset mr-1"></i> My Approvals</button>
                    <button id="tab-btn-admin" class="tab-btn text-slate-600 hover:text-teal-600 py-3 px-5 hidden focus:outline-none text-sm font-medium" data-tab="admin-dashboard"><i class="ph-gauge mr-1"></i> Admin Dashboard</button>
                     <button id="tab-btn-analytics" class="tab-btn text-slate-600 hover:text-teal-600 py-3 px-5 hidden focus:outline-none text-sm font-medium" data-tab="summary-analytics"><i class="ph-chart-bar mr-1"></i> Summary & Analytics</button>

                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto py-8 sm:py-10 px-4 sm:px-6 lg:px-8">

             <!-- ========================= -->
             <!--      POLICY TAB           -->
             <!-- ========================= -->
            <div id="policy" class="tab-content tab-content-active space-y-6">
                <h2 class="text-3xl font-bold text-slate-900 mb-6">Reimbursement Policy & Procedure</h2>

                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <h3 class="text-xl font-semibold text-slate-800 mb-3 flex items-center"><i class="ph-info text-blue-600 mr-2 text-2xl"></i> Overview</h3>
                    <p class="text-slate-600 text-sm leading-relaxed">
                        This portal handles SVA expense pre-approvals and reimbursements. Following these tiers ensures compliance and timely processing. Submit requests here unless the expense exceeds Tier 3 limits.
                    </p>
                     <p class="text-slate-600 text-sm leading-relaxed mt-2">
                        Questions? Contact <a href="mailto:admin@svamail.com" class="text-teal-600 hover:underline font-medium">admin@svamail.com</a>.
                    </p>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                     <h3 class="text-xl font-semibold text-slate-800 mb-4 flex items-center"><i class="ph-stack text-blue-600 mr-2 text-2xl"></i> Expense Tiers & Approvals</h3>
                     <div class="space-y-6">

                         <!-- Tier 1 -->
                        <div class="policy-tier border-l-blue-500">
                            <h4 class="font-bold text-lg text-blue-800">Tier 1: Up to $<span class="tier-limit" data-tier="1">200.00</span></h4>
                            <ul class="list-disc list-inside text-sm text-slate-700">
                                <li><strong>Purpose:</strong> Routine small expenses (e.g., classroom supplies).</li>
                                <li><strong>Pre-Approval:</strong> <strong class="text-green-700">None required.</strong></li>
                                <li><strong>Payment:</strong> Personal funds (reimbursement preferred) or School Account (discouraged, needs justification).</li>
                                <li><strong>Docs:</strong> <strong class="text-red-600">Receipt</strong> (for reimbursement) or <strong class="text-red-600">Quote</strong> (for school payment).</li>
                                <li><strong>Process:</strong> Submit via portal. Reimbursements usually auto-approved; School Payments route to Admin.</li>
                            </ul>
                        </div>

                         <!-- Tier 2 -->
                        <div class="policy-tier border-l-yellow-500">
                            <h4 class="font-bold text-lg text-yellow-800">Tier 2: $<span class="tier-limit" data-tier="1-plus">200.01</span> - $<span class="tier-limit" data-tier="2">1000.00</span></h4>
                             <ul class="list-disc list-inside text-sm text-slate-700">
                                <li><strong>Purpose:</strong> Moderate expenses (e.g., larger supplies, small equipment).</li>
                                <li><strong>Pre-Approval:</strong> <strong class="text-red-600">Admin approval REQUIRED BEFORE purchase</strong> (via email/written form).</li>
                                <li><strong>Payment:</strong> Personal funds or School Account, <strong class="text-red-600">only after</strong> pre-approval.</li>
                                 <li><strong>Docs:</strong> <strong class="text-red-600">Admin Pre-Approval Proof</strong> + (<strong class="text-red-600">Receipt</strong> for reimbursement OR <strong class="text-red-600">Quote</strong> for school payment).</li>
                                <li><strong>Process:</strong> Submit via portal with all docs. Routes to Admin for final portal approval.</li>
                             </ul>
                        </div>

                         <!-- Tier 3 -->
                        <div class="policy-tier border-l-orange-600">
                            <h4 class="font-bold text-lg text-orange-800">Tier 3: $<span class="tier-limit" data-tier="2-plus">1000.01</span> - $<span class="tier-limit" data-tier="3">5000.00</span></h4>
                             <ul class="list-disc list-inside text-sm text-slate-700">
                                 <li><strong>Purpose:</strong> Significant expenses (e.g., major equipment, contracts).</li>
                                 <li><strong>Pre-Approval:</strong> <strong class="text-red-600">Admin AND designated Board Member approval REQUIRED BEFORE purchase</strong> (via email/written form).</li>
                                 <li><strong>Payment:</strong> <strong class="text-red-700">School Account ONLY.</strong> No reimbursement allowed.</li>
                                 <li><strong>Docs:</strong> <strong class="text-red-600">Admin & Board Pre-Approval Proof</strong> + Vendor <strong class="text-red-600">Quote/Invoice</strong>.</li>
                                 <li><strong>Process:</strong> Submit "School Payment Request" via portal with all docs. Routes to Admin, then Board for final portal approvals.</li>
                            </ul>
                        </div>

                         <!-- Over Tier 3 -->
                         <div class="policy-tier border-l-red-600">
                             <h4 class="font-bold text-lg text-red-800">Over $<span class="tier-limit" data-tier="3">5000.00</span></h4>
                              <p class="text-sm text-slate-700">
                                 Expenses over $<span class="tier-limit" data-tier="3">5000.00</span> require direct Board review. Do not use this portal. Email <a href="mailto:bod@svamail.com" class="font-medium text-teal-600 hover:underline">bod@svamail.com</a> with justification and quotes.
                             </p>
                         </div>
                     </div>
                </div>

                 <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                     <h3 class="text-xl font-semibold text-slate-800 mb-3 flex items-center"><i class="ph-check-square-offset text-blue-600 mr-2 text-2xl"></i> General Guidelines</h3>
                    <ul class="list-disc list-inside text-sm text-slate-600 space-y-2">
                        <li><strong>Submission Deadline:</strong> Submit reimbursements within <strong class="text-indigo-700">30 days</strong> of purchase. Submit pre-approvals in advance.</li>
                        <li><strong>Documentation Standards:</strong> Receipts must be itemized and show vendor, date, amount, and proof of payment. Quotes/Invoices require vendor details, items, and cost. Pre-Approval proof must be written confirmation.</li>
                        <li><strong>File Requirements:</strong> Attachments must be <strong class="text-indigo-700">PDF, PNG, JPG, or JPEG</strong> and under <strong class="text-indigo-700">10MB each</strong>. Combine pages into one PDF if possible.</li>
                        <li><strong>Approval Time:</strong> Approvers aim to review within <strong class="text-indigo-700">5 business days</strong>. Admins may override after 5 days if needed.</li>
                        <li><strong>Payment:</strong> Approved reimbursements paid in 1-2 weeks. School payments made directly to vendor. Status updates to "Check Issued".</li>
                        <li><strong>Compliance:</strong> Missing pre-approvals or docs may cause delays/denial.</li>
                         <li><strong>Budget:</strong> Approvals are subject to budget availability.</li>
                    </ul>
                 </div>
            </div>

             <!-- ========================= -->
             <!--     NEW REQUEST TAB       -->
             <!-- ========================= -->
            <div id="new-request" class="tab-content">
                <h2 class="text-3xl font-bold text-slate-900 mb-6">Submit New Expense Request</h2>
                <form id="expense-form" class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 space-y-6">

                    <!-- Submitter Info -->
                    <fieldset>
                        <legend class="text-lg font-semibold text-slate-800 mb-3 border-b pb-2">Your Information</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 form-grid">
                            <div>
                                <label for="submitter-name" class="block text-sm font-medium text-slate-700">Full Name</label>
                                <input type="text" id="submitter-name" name="submitterName" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500" required>
                            </div>
                            <div>
                                <label for="submitter-email" class="block text-sm font-medium text-slate-700">Email Address</label>
                                <input type="email" id="submitter-email" name="submitterEmail" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500" required>
                            </div>
                            <div>
                                <label for="submitter-role" class="block text-sm font-medium text-slate-700">Your Role at SVA</label>
                                <select id="submitter-role" name="submitterRole" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500" required>
                                    <option value="">Select Role...</option>
                                    <option>Teacher</option>
                                    <option>Staff</option>
                                    <option>Admin</option>
                                    <option>Board Member</option>
                                    <option>PTO Volunteer</option>
                                    <option>Parent Volunteer</option>
                                    <option>Other</option>
                                </select>
                            </div>
                        </div>
                    </fieldset>

                     <!-- Expense Details -->
                    <fieldset>
                        <legend class="text-lg font-semibold text-slate-800 mb-3 border-b pb-2">Expense Details</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 form-grid">
                            <div>
                                <label for="category" class="block text-sm font-medium text-slate-700">Category</label>
                                <select id="category" name="category" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500" required>
                                    <option value="">Loading Categories...</option>
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                             <div>
                                <label for="amount" class="block text-sm font-medium text-slate-700">Amount ($)</label>
                                <input type="number" id="amount" name="amount" step="0.01" min="0.01" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500" required placeholder="e.g., 55.25">
                            </div>
                             <div>
                                <label for="vendor" class="block text-sm font-medium text-slate-700">Vendor / Store Name</label>
                                <input type="text" id="vendor" name="vendor" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500" required placeholder="e.g., Amazon, Office Depot">
                            </div>
                             <div>
                                <label for="purchase-date" class="block text-sm font-medium text-slate-700">Date of Purchase/Quote</label>
                                <input type="date" id="purchase-date" name="date_purshase" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500">
                             </div>
                        </div>
                        <div class="mt-4">
                            <label for="description" class="block text-sm font-medium text-slate-700">Description / Justification</label>
                            <textarea id="description" name="description" rows="3" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500" required placeholder="Briefly explain the purpose of the expense."></textarea>
                        </div>
                    </fieldset>

                     <!-- Tier & Policy Info -->
                     <div id="tier-info" class="p-4 border rounded-md bg-slate-50 border-slate-200 hidden">
                          <h4 class="font-semibold text-slate-700 flex items-center">
                              <i class="ph-info mr-2 text-xl"></i> Policy for Tier <span id="tier-level">X</span> ($<span id="tier-amount-display">0.00</span>)
                          </h4>
                          <p id="tier-message" class="text-sm text-slate-600 mt-2"></p>
                          <input type="hidden" id="tier" name="tier">
                     </div>

                      <!-- Request Type & Payment Method -->
                     <fieldset id="request-type-payment-section" class="hidden">
                         <legend class="text-lg font-semibold text-slate-800 mb-3 border-b pb-2">Request Type & Payment</legend>
                          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 form-grid">
                             <div>
                                <label for="request-type" class="block text-sm font-medium text-slate-700">Request Type</label>
                                <select id="request-type" name="requestType" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500">
                                    <option value="">Select Type...</option>
                                    <option value="reimbursement">Reimbursement (Paid with Personal Funds)</option>
                                    <option value="preapproval">Pre-Approval / School Payment Request</option>
                                </select>
                            </div>
                             <div id="payment-method-container" class="hidden">
                                <label for="payment-method" class="block text-sm font-medium text-slate-700">Payment Method Used/Requested</label>
                                <select id="payment-method" name="paymentMethod" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:ring-teal-500 focus:border-teal-500">
                                    <option value="">Select Method...</option>
                                    <option value="Personal Funds">Personal Funds (Reimbursement)</option>
                                    <option value="School Account">School Account (Requires Pre-Approval)</option>
                                </select>
                            </div>
                         </div>
                     </fieldset>

                      <!-- File Uploads -->
                    <fieldset id="file-uploads-section" class="hidden">
                        <legend class="text-lg font-semibold text-slate-800 mb-3 border-b pb-2">Attachments</legend>
                        <p class="text-xs text-slate-500 mb-3">Allowed file types: PDF, PNG, JPG, JPEG. Max size: 10MB per file.</p>
                        <div class="space-y-4">
                             <div id="receipt-upload" class="hidden">
                                <label for="receipt" class="block text-sm font-medium text-slate-700">Receipt / Final Invoice <span class="text-red-500">*</span></label>
                                <input type="file" id="receipt" name="receipt" accept=".pdf,.png,.jpg,.jpeg" class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border file:border-slate-300 file:text-sm file:font-semibold file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200 cursor-pointer">
                                <p class="mt-1 text-xs text-slate-500">Required for Reimbursements. Clear, itemized receipt showing vendor, date, items, and total amount.</p>
                            </div>
                             <div id="quote-upload" class="hidden">
                                <label for="quote" class="block text-sm font-medium text-slate-700">Quote / Estimate <span class="text-red-500">*</span></label>
                                <input type="file" id="quote" name="quote" accept=".pdf,.png,.jpg,.jpeg" class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border file:border-slate-300 file:text-sm file:font-semibold file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200 cursor-pointer">
                                <p class="mt-1 text-xs text-slate-500">Required for Pre-Approval / School Payment requests. Show vendor, items, and total cost.</p>
                            </div>
                             <div id="preapproval-upload" class="hidden">
                                <label for="pre-approval" class="block text-sm font-medium text-slate-700">Pre-Approval Documentation <span class="text-red-500">*</span></label>
                                <input type="file" id="pre-approval" name="preApproval" accept=".pdf,.png,.jpg,.jpeg" class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border file:border-slate-300 file:text-sm file:font-semibold file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200 cursor-pointer">
                                <p class="mt-1 text-xs text-slate-500">Required for Tiers 2 & 3. Attach the email or document showing prior approval from Admin (and Board for Tier 3).</p>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Submission Area -->
                    <div class="border-t border-slate-200 pt-5">
                        <div id="amount-too-high-msg" class="hidden text-center p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg border border-red-300" role="alert">
                            <span class="font-medium">Amount Too High for Portal:</span> Expenses over $<span class="tier-limit" data-tier="3">5000</span> require direct Board approval. Please email <a href="mailto:bod@svamail.com" class="font-bold hover:underline">bod@svamail.com</a> with details. Submission via this form is disabled for this amount.
                        </div>
                        <button type="submit" id="submit-btn" class="w-full sm:w-auto inline-flex items-center justify-center bg-teal-600 text-white font-semibold py-2.5 px-6 rounded-lg hover:bg-teal-700 transition disabled:bg-slate-400 disabled:cursor-not-allowed shadow-sm">
                            <i class="ph-paper-plane-tilt mr-2"></i> Submit Request
                        </button>
                    </div>

                    <!-- Hidden action field for backend routing -->
                    <input type="hidden" name="action" value="submitRequest">
                </form>
            </div>

             <!-- Check Status Tab - REMOVED -->
            <!-- <div id="check-status" class="tab-content"></div> -->


             <!-- ========================= -->
             <!-- PENDING APPROVALS TAB     -->
             <!-- ========================= -->
            <div id="pending-approvals" class="tab-content hidden">
                 <h2 class="text-3xl font-bold text-slate-900 mb-6">My Pending Approvals</h2>
                 <div id="approvals-list" class="space-y-6">
                     <!-- Approvals loaded here by JS -->
                      <p class="text-slate-500">Loading your pending approvals...</p>
                 </div>
            </div>

            <!-- ========================= -->
            <!--   ADMIN DASHBOARD TAB     -->
            <!-- ========================= -->
            <div id="admin-dashboard" class="tab-content hidden">
                 <h2 class="text-3xl font-bold text-slate-900 mb-6">Admin Dashboard: All Approved / Paid Requests</h2>
                  <div class="mb-4 text-sm text-slate-600">View approved requests awaiting payment and recently completed payments.</div>
                 <div id="admin-tasks-list" class="space-y-6">
                     <!-- Admin tasks loaded here by JS -->
                     <p class="text-slate-500">Loading admin tasks...</p>
                 </div>
            </div>

            <!-- ========================= -->
            <!-- SUMMARY & ANALYTICS TAB   -->
            <!-- ========================= -->
            <div id="summary-analytics" class="tab-content hidden">
                <h2 class="text-3xl font-bold text-slate-900 mb-6">Summary & Analytics</h2>
                <div id="analytics-content" class="space-y-6">
                    <p class="text-slate-500">Loading analytics data...</p>
                     <!-- Analytics data rendered here by JS -->
                 </div>
            </div>

        </main>

        <footer class="bg-white mt-12 border-t border-slate-200">
             <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center text-slate-500 text-sm">
                 <p>&copy; <span id="current-year"></span> Silicon Valley Academy. For portal issues contact <a href="mailto:admin@svamail.com" class="text-teal-600 hover:underline">admin@svamail.com</a>.</p>
             </div>
        </footer>
    </div>


    <script>
        // --- CONFIGURATION ---
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzD0IJtgmaKSEXu45UiPdQBMSOgLM4vUPlLHBszKpoidTy1AveJS_rF_z7KK1H9RYe8bg/exec'; // User provided URL
        const CLIENT_ID = "14216824305-v19ecsmrhk1muaglrlhjceqjk5oeqr4n.apps.googleusercontent.com"; // From parent portal
        const MAX_FILE_SIZE_MB = 10;
        const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;
        const ALLOWED_FILE_TYPES = ['application/pdf', 'image/png', 'image/jpeg', 'image/jpg'];
        const ALLOWED_EXTENSIONS = ['.pdf', '.png', '.jpg', '.jpeg'];

        let ID_TOKEN = null;
        let USER_PROFILE = null; // Store user profile info { name, email, isAdmin }
        let TIER_LIMITS = { tier1: 200, tier2: 1000, tier3: 5000 }; // Default, updated on load
        let CATEGORIES = [];

        // --- DOM Elements ---
        const amountInput = document.getElementById('amount');
        const tierInfoDiv = document.getElementById('tier-info');
        const tierLevelSpan = document.getElementById('tier-level');
        const tierAmountSpan = document.getElementById('tier-amount-display');
        const tierMessageP = document.getElementById('tier-message');
        const tierInput = document.getElementById('tier');
        const requestTypePaymentSection = document.getElementById('request-type-payment-section');
        const requestTypeSelect = document.getElementById('request-type');
        const paymentMethodContainer = document.getElementById('payment-method-container');
        const paymentMethodSelect = document.getElementById('payment-method');
        const fileUploadsSection = document.getElementById('file-uploads-section');
        const receiptUploadDiv = document.getElementById('receipt-upload');
        const quoteUploadDiv = document.getElementById('quote-upload');
        const preApprovalUploadDiv = document.getElementById('preapproval-upload');
        const receiptInput = document.getElementById('receipt');
        const quoteInput = document.getElementById('quote');
        const preApprovalInput = document.getElementById('pre-approval');
        const submitBtn = document.getElementById('submit-btn');
        const amountTooHighMsg = document.getElementById('amount-too-high-msg');
        const expenseForm = document.getElementById('expense-form');
        const loadingOverlay = document.getElementById('loading-overlay');
        const messageContainer = document.getElementById('message-container');
        const userInfoDiv = document.getElementById('user-info');
        const userNameP = document.getElementById('user-name');
        const userEmailP = document.getElementById('user-email');
        const signInButtonDiv = document.getElementById('google-signin-button');
        const signOutButton = document.getElementById('sign-out-button');

        // Tab Buttons & Content
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const secureTabButtons = [
            document.getElementById('tab-btn-approvals'),
            document.getElementById('tab-btn-admin'),
            document.getElementById('tab-btn-analytics')
        ];
        const secureTabs = [
            document.getElementById('pending-approvals'),
            document.getElementById('admin-dashboard'),
            document.getElementById('summary-analytics')
        ];

        // --- UTILITY FUNCTIONS ---
        function showLoading() { loadingOverlay.classList.remove('hidden'); }
        function hideLoading() { loadingOverlay.classList.add('hidden'); }

        function showMessage(type, text, duration = 5000) {
            const messageDiv = document.createElement('div');
            let bgColor, textColor, borderColor, icon;

            switch(type) {
                case 'success':
                    bgColor = 'bg-green-100'; textColor = 'text-green-800'; borderColor = 'border-green-300'; icon = 'ph-check-circle';
                    break;
                case 'error':
                     bgColor = 'bg-red-100'; textColor = 'text-red-800'; borderColor = 'border-red-300'; icon = 'ph-x-circle';
                    break;
                default:
                     bgColor = 'bg-blue-100'; textColor = 'text-blue-800'; borderColor = 'border-blue-300'; icon = 'ph-info';
            }

            messageDiv.className = `p-4 mb-4 text-sm rounded-lg border shadow-md ${bgColor} ${textColor} ${borderColor} flex items-start`; // Use items-start
            messageDiv.innerHTML = `<i class="${icon} text-xl mr-2 flex-shrink-0 mt-0.5"></i> <span>${text}</span>`; // Added mt-0.5 to icon
            messageContainer.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.style.transition = 'opacity 0.5s ease-out';
                messageDiv.style.opacity = '0';
                setTimeout(() => messageDiv.remove(), 500);
            }, duration);
        }

         function formatCurrency(amount) {
             // Ensure amount is a number before formatting
             const numAmount = Number(amount);
             if (isNaN(numAmount)) return '$--.--'; // Or some placeholder
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(numAmount);
        }

        function cleanUrlParams() {
             try {
                // Use replaceState to avoid adding to history, remove query params
                 window.history.replaceState({}, document.title, window.location.pathname);
             } catch (e) {
                console.warn("Could not clean URL parameters:", e.message);
                // Silently fail if history manipulation is restricted (e.g., in sandboxed iframes)
             }
        }


        // --- GOOGLE SIGN-IN ---
        function initializeGoogleSignIn() {
             try {
                google.accounts.id.initialize({
                    client_id: CLIENT_ID,
                    callback: handleCredentialResponse,
                });
                google.accounts.id.renderButton(
                    signInButtonDiv,
                    { theme: "outline", size: "medium", text: "sign_in_with", shape: "pill" }
                );
                 google.accounts.id.prompt(); // Show One Tap prompt
             } catch (error) {
                 console.error("Google Sign-In initialization failed:", error);
                 signInButtonDiv.innerHTML = `<p class="text-xs text-red-600">Login unavailable</p>`;
             }
        }

        function handleCredentialResponse(response) {
            ID_TOKEN = response.credential;
            // Optionally decode to get email immediately for UI, but verify on backend
            const profile = JSON.parse(atob(ID_TOKEN.split('.')[1]));
            USER_PROFILE = { name: profile.name, email: profile.email }; // Temporary profile

            // Update UI immediately (visual feedback)
            updateLoginUI(true);

            // Fetch secure data
            fetchApproverData();
             // Fetch analytics only after login (will check isAdmin internally)
            fetchAnalyticsData();

             // Switch to a relevant tab if needed, e.g., approvals
             switchToTab('pending-approvals'); // Default to approvals tab after login

             showMessage('success', `Signed in as ${profile.email}`);
        }

        function handleSignOut() {
             if (!USER_PROFILE || !USER_PROFILE.email) {
                 console.warn("Attempted sign out without user profile.");
                 // Force UI update anyway
                  ID_TOKEN = null;
                  USER_PROFILE = null;
                  updateLoginUI(false);
                  switchToTab('policy');
                 return;
             }
            google.accounts.id.disableAutoSelect();
             google.accounts.id.revoke(USER_PROFILE.email, done => {
                console.log('Google Sign-In consent revoked.');
             });
            ID_TOKEN = null;
            USER_PROFILE = null;
            updateLoginUI(false);
            showMessage('info', 'You have been signed out.');
            switchToTab('policy'); // Go back to public view
        }

        function updateLoginUI(isLoggedIn) {
            if (isLoggedIn && USER_PROFILE) {
                userNameP.textContent = USER_PROFILE.name || 'User';
                userEmailP.textContent = USER_PROFILE.email;
                userInfoDiv.classList.remove('hidden');
                signInButtonDiv.classList.add('hidden');
                signOutButton.classList.remove('hidden');

                // Show/Hide secure tabs based on isAdmin (determined by backend via fetchApproverData)
                // Note: USER_PROFILE.isAdmin might not be set immediately after login, fetchApproverData updates it
                const isAdmin = USER_PROFILE?.isAdmin || false; // Default to false if not yet known
                secureTabButtons.forEach(btn => {
                    const isAdminOnly = btn.id === 'tab-btn-admin' || btn.id === 'tab-btn-analytics';
                    btn.classList.toggle('hidden', isAdminOnly && !isAdmin);
                });
                 // Approvals tab is always shown if logged in (backend handles who sees what)
                 document.getElementById('tab-btn-approvals').classList.remove('hidden');


            } else {
                userInfoDiv.classList.add('hidden');
                signInButtonDiv.classList.remove('hidden');
                signOutButton.classList.add('hidden');
                // Hide secure tabs
                secureTabButtons.forEach(btn => btn.classList.add('hidden'));
                 document.getElementById('tab-btn-approvals').classList.add('hidden'); // Also hide approvals
                secureTabs.forEach(tab => tab.classList.add('hidden')); // Ensure content is hidden too
            }
             // Re-render Phosphor icons if visibility changed
             if (typeof phosphor !== 'undefined') phosphor.replace();
        }

        // --- TABS ---
        function switchToTab(tabId) {
            // Ensure valid tabId
            const validTabs = ['policy', 'new-request', 'pending-approvals', 'admin-dashboard', 'summary-analytics'];
            if (!validTabs.includes(tabId)) {
                console.warn(`Invalid tab ID requested: ${tabId}. Defaulting to policy.`);
                tabId = 'policy';
            }

            // Special handling for secure tabs if user is not logged in or not admin
             if (!ID_TOKEN && (tabId === 'pending-approvals' || tabId === 'admin-dashboard' || tabId === 'summary-analytics')) {
                  showMessage('error', 'Please sign in to access this section.');
                  switchToTab('policy'); // Redirect to policy
                  return; // Stop further processing
             }
              if (ID_TOKEN && !USER_PROFILE?.isAdmin && (tabId === 'admin-dashboard' || tabId === 'summary-analytics')) {
                  showMessage('error', 'Admin privileges required for this section.');
                   switchToTab('pending-approvals'); // Redirect admin-only attempts to approvals
                  return; // Stop further processing
             }


            tabButtons.forEach(button => {
                // Only toggle active state if the button corresponds to the target tab
                button.classList.toggle('tab-active', button.dataset.tab === tabId);
                 button.classList.toggle('text-slate-600', button.dataset.tab !== tabId);
            });

            tabContents.forEach(content => {
                // Only show the content if its ID matches the target tab
                content.classList.toggle('tab-content-active', content.id === tabId);
                 content.classList.toggle('hidden', content.id !== tabId);
            });

             cleanUrlParams(); // Clean URL when switching tabs
        }


        // --- FORM LOGIC ---
        function updateTierInfo(amount) {
            let tier = 0;
            let message = "";
            let canSubmit = true; // Flag to enable/disable submission

             // Use precise values from TIER_LIMITS
             const tier1Max = TIER_LIMITS.tier1;
             const tier2Max = TIER_LIMITS.tier2;
             const tier3Max = TIER_LIMITS.tier3;

            if (amount > 0 && amount <= tier1Max) {
                tier = 1;
                message = `<strong>Tier 1:</strong> No pre-approval needed. Requires receipt for reimbursement.`; // Made concise
            } else if (amount > tier1Max && amount <= tier2Max) {
                tier = 2;
                message = `<strong>Tier 2:</strong> Requires <strong>Admin pre-approval BEFORE purchase</strong>. Attach pre-approval proof + receipt (reimbursement) or quote (school payment).`; // Made concise
            } else if (amount > tier2Max && amount <= tier3Max) {
                tier = 3;
                message = `<strong>Tier 3:</strong> Requires <strong>Admin AND designated Board Member pre-approval BEFORE purchase</strong>. Payment MUST use school account. Attach pre-approval proof + quote.`; // Made concise & updated board approval
            } else if (amount > tier3Max) {
                tier = 4; // Special case for > Tier 3
                message = `<strong>Amount exceeds Tier 3 limit (${formatCurrency(tier3Max)})</strong>. Use email for requests over ${formatCurrency(tier3Max)}. Contact <a href="mailto:bod@svamail.com" class="font-medium text-teal-600 hover:underline">bod@svamail.com</a>.`; // Made concise
                canSubmit = false; // Disable submission
            } else {
                 tierInfoDiv.classList.add('hidden');
                 requestTypePaymentSection.classList.add('hidden');
                 fileUploadsSection.classList.add('hidden');
                 submitBtn.disabled = true; // Disable if amount is 0 or invalid
                 amountTooHighMsg.classList.add('hidden');
                return; // Exit if amount is invalid or zero
            }

            tierLevelSpan.textContent = tier <= 3 ? tier : 'N/A';
            tierAmountSpan.textContent = amount.toFixed(2);
            tierMessageP.innerHTML = message;
            tierInput.value = tier;
            tierInfoDiv.classList.remove('hidden');

             // Show/hide amount too high message and disable submit button
             amountTooHighMsg.classList.toggle('hidden', canSubmit);
             submitBtn.disabled = !canSubmit;

             // Show subsequent sections only if within submittable tiers (1-3)
             requestTypePaymentSection.classList.toggle('hidden', tier === 0 || tier === 4);
             fileUploadsSection.classList.toggle('hidden', tier === 0 || tier === 4);


            // Update requirements based on tier and request type
            updateFormRequirements(tier, requestTypeSelect.value);
        }

        function updateFormRequirements(tier, requestType) {
            let needsReceipt = false;
            let needsQuote = false;
            let needsPreApprovalDoc = false;

            // Reset visibility and required status
            [receiptUploadDiv, quoteUploadDiv, preApprovalUploadDiv].forEach(div => div.classList.add('hidden'));
            [receiptInput, quoteInput, preApprovalInput].forEach(input => {input.required = false; input.value = ''; /* Clear file input */ }); // Clear previous selection
            paymentMethodContainer.classList.add('hidden');
            paymentMethodSelect.required = false;
            paymentMethodSelect.disabled = false; // Ensure enabled by default


            if (tier === 0 || tier === 4) return; // Exit if invalid tier

            // Show payment method based on tier, except when request type isn't selected
            if (requestType) {
                 paymentMethodContainer.classList.remove('hidden');
                 paymentMethodSelect.required = true;
            }


            // Determine required attachments based on tier and request type
            if (requestType === 'reimbursement') {
                needsReceipt = true;
                if (tier === 2 || tier === 3) { // Tier 3 Technically not allowed, but keep logic for safety
                    needsPreApprovalDoc = true;
                }
                 // Enforce payment method for reimbursement, but DO NOT disable
                 paymentMethodSelect.value = 'Personal Funds';


            } else if (requestType === 'preapproval') { // Covers both Pre-Approval and School Payment Request scenarios
                needsQuote = true;
                 if (tier === 2 || tier === 3) {
                     // Attach pre-approval ONLY if this is the request *after* getting initial email approval
                     // Let's make it required for Tier 2/3 school payment request.
                     needsPreApprovalDoc = true;
                 }
                 // Allow selecting payment method, but enforce School Account for Tier 3
                 if (tier === 3) {
                      paymentMethodSelect.value = 'School Account';
                      paymentMethodSelect.disabled = true; // Lock Tier 3 to School Account
                 }
            } else {
                // If request type is not selected, hide payment method and files
                 paymentMethodContainer.classList.add('hidden');
                 paymentMethodSelect.required = false;
            }


            // Set visibility and required status for file inputs
            receiptUploadDiv.classList.toggle('hidden', !needsReceipt);
            receiptInput.required = needsReceipt;
            quoteUploadDiv.classList.toggle('hidden', !needsQuote);
            quoteInput.required = needsQuote;
            preApprovalUploadDiv.classList.toggle('hidden', !needsPreApprovalDoc);
            preApprovalInput.required = needsPreApprovalDoc;

        }

         // --- NEW: File Validation Function ---
         function validateFiles() {
             const filesToValidate = [
                 { input: receiptInput, label: "Receipt" },
                 { input: quoteInput, label: "Quote" },
                 { input: preApprovalInput, label: "Pre-Approval Doc" }
             ];

             for (const item of filesToValidate) {
                 // Check only if the input is required and visible
                 if (item.input.required && !item.input.closest('div').classList.contains('hidden')) {
                     if (item.input.files.length === 0) {
                         showMessage('error', `Missing required file: ${item.label}.`);
                         return false; // Missing required file
                     }

                     const file = item.input.files[0];

                     // 1. Check File Type (MIME type or extension)
                     const fileType = file.type;
                     const fileName = file.name.toLowerCase();
                     const fileExtension = fileName.substring(fileName.lastIndexOf('.'));

                     const isValidType = ALLOWED_FILE_TYPES.includes(fileType) || ALLOWED_EXTENSIONS.includes(fileExtension);

                     if (!isValidType) {
                         showMessage('error', `Invalid file type for ${item.label}: "${fileName}". Allowed types: PDF, PNG, JPG, JPEG.`);
                         return false;
                     }

                     // 2. Check File Size
                     if (file.size > MAX_FILE_SIZE_BYTES) {
                         showMessage('error', `File size limit exceeded for ${item.label}: "${fileName}" (${(file.size / 1024 / 1024).toFixed(1)}MB). Max size: ${MAX_FILE_SIZE_MB}MB.`);
                         return false;
                     }
                 } else if (!item.input.closest('div').classList.contains('hidden') && item.input.files.length > 0) {
                     // Validate optional files if they are selected
                      const file = item.input.files[0];
                      const fileType = file.type;
                      const fileName = file.name.toLowerCase();
                      const fileExtension = fileName.substring(fileName.lastIndexOf('.'));
                      const isValidType = ALLOWED_FILE_TYPES.includes(fileType) || ALLOWED_EXTENSIONS.includes(fileExtension);
                       if (!isValidType) {
                         showMessage('error', `Invalid file type for ${item.label}: "${fileName}". Allowed types: PDF, PNG, JPG, JPEG.`);
                         return false;
                     }
                      if (file.size > MAX_FILE_SIZE_BYTES) {
                         showMessage('error', `File size limit exceeded for ${item.label}: "${fileName}" (${(file.size / 1024 / 1024).toFixed(1)}MB). Max size: ${MAX_FILE_SIZE_MB}MB.`);
                         return false;
                     }
                 }
             }
             return true; // All required and selected optional files are valid
         }


        function handleFormSubmit(event) {
            event.preventDefault();

             // --- ADD FILE VALIDATION CALL ---
             if (!validateFiles()) {
                 // Re-enable button immediately if validation fails client-side
                 submitBtn.disabled = false;
                 submitBtn.innerHTML = '<i class="ph-paper-plane-tilt mr-2"></i> Submit Request';
                  if (typeof phosphor !== 'undefined') phosphor.replace();
                 return; // Stop submission
             }
             // --- END FILE VALIDATION ---


            showLoading();
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            const formData = new FormData(expenseForm);
            // Append action explicitly if not already in FormData (it should be)
             if (!formData.has('action')) {
                formData.append('action', 'submitRequest');
             }

            // Log FormData contents for debugging (optional)
            // console.log("Submitting FormData:");
            // for (let [key, value] of formData.entries()) {
            //     if (value instanceof File) {
            //         console.log(`${key}: File(${value.name}, size=${value.size}, type=${value.type})`);
            //     } else {
            //         console.log(`${key}: ${value}`);
            //     }
            // }

            fetch(WEB_APP_URL, {
                method: 'POST',
                body: formData, // Send as FormData
            })
            .then(response => {
                if (!response.ok) { // Check for HTTP errors (like 500, 404)
                     throw new Error(`Network response was not ok (${response.status})`);
                }
                return response.json(); // Assuming backend sends JSON response
            })
            .then(data => {
                if (data.status === 'success') {
                    showMessage('success', `Request submitted successfully! Your Request ID is: ${data.requestId}`);
                    expenseForm.reset();
                    // Reset tier info and dependent fields
                    updateTierInfo(0);
                } else {
                    throw new Error(data.message || 'Submission failed. Unknown error from backend.');
                }
            })
            .catch(error => {
                console.error('Submission Error:', error);
                showMessage('error', `Submission failed: ${error.message}`);
            })
            .finally(() => {
                hideLoading();
                submitBtn.disabled = false; // Re-enable unless amount is too high
                 updateTierInfo(parseFloat(amountInput.value) || 0); // Re-run tier check to potentially keep it disabled
                 // Reset button text
                 submitBtn.innerHTML = '<i class="ph-paper-plane-tilt mr-2"></i> Submit Request';
                 if (typeof phosphor !== 'undefined') phosphor.replace(); // Update icon if needed
            });
        }

        // --- DATA FETCHING ---
        function fetchPublicData() {
            showLoading();
            fetch(`${WEB_APP_URL}?action=getPublicData`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        TIER_LIMITS = data.tierLimits;
                        CATEGORIES = data.categories;
                        populateCategories();
                        updateTierLimitsDisplay();
                    } else {
                        throw new Error(data.message || 'Failed to load config data.');
                    }
                })
                .catch(error => {
                    console.error('Error fetching public data:', error);
                    showMessage('error', `Could not load configuration: ${error.message}`);
                    // Set default tiers display on error?
                     updateTierLimitsDisplay(); // Update with defaults on error
                })
                 .finally(() => hideLoading()); // Ensure loading is hidden even on error
        }

         function fetchApproverData() {
            if (!ID_TOKEN) return; // Don't fetch if not logged in
            showLoading();
             // Clear previous data while loading
             renderPendingApprovals([]);
             renderAdminTasks([]);

            fetch(`${WEB_APP_URL}?action=getApproverData&token=${ID_TOKEN}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Store admin status in the user profile
                        if (USER_PROFILE) {
                           USER_PROFILE.isAdmin = data.isAdmin;
                           USER_PROFILE.myApprovals = data.myApprovals; // Store approvals for modal
                        }
                        renderPendingApprovals(data.myApprovals);
                        if (data.isAdmin) {
                            renderAdminTasks(data.adminTasks);
                             // Update UI again to ensure admin tabs are shown if backend confirms isAdmin
                             updateLoginUI(true);
                        } else {
                             // Ensure admin tabs are hidden if backend says user is not admin
                             document.getElementById('tab-btn-admin').classList.add('hidden');
                             document.getElementById('admin-dashboard').classList.add('hidden');
                              document.getElementById('tab-btn-analytics').classList.add('hidden');
                             document.getElementById('summary-analytics').classList.add('hidden');
                        }
                    } else {
                        throw new Error(data.message || 'Failed to load approver data.');
                    }
                })
                .catch(error => {
                    console.error('Error fetching approver data:', error);
                    showMessage('error', `Could not load your data: ${error.message}`);
                    // Clear data displays on error
                     renderPendingApprovals(null); // Pass null to show error message
                     renderAdminTasks(null);
                    // If token is invalid, sign out
                    if (error.message.includes("failed") || error.message.includes("invalid") || error.message.includes("Token expired")) {
                        handleSignOut();
                    }
                })
                 .finally(() => hideLoading());
        }

         function fetchAnalyticsData() {
             if (!ID_TOKEN || !USER_PROFILE?.isAdmin) {
                 document.getElementById('analytics-content').innerHTML = ''; // Clear if not admin
                 return; // Only fetch if logged in as admin
             }
             showLoading();
             document.getElementById('analytics-content').innerHTML = '<p class="text-slate-500">Loading analytics data...</p>'; // Loading message

             fetch(`${WEB_APP_URL}?action=getAnalyticsData&token=${ID_TOKEN}`)
                 .then(response => response.json())
                 .then(data => {
                     if (data.status === 'success') {
                         renderAnalytics(data.summary);
                     } else {
                         throw new Error(data.message || 'Failed to load analytics data.');
                     }
                 })
                 .catch(error => {
                     console.error('Error fetching analytics data:', error);
                     showMessage('error', `Could not load analytics: ${error.message}`);
                     document.getElementById('analytics-content').innerHTML = `<p class="text-red-500">Failed to load analytics data.</p>`;
                 })
                 .finally(() => hideLoading());
         }


        // --- RENDERING FUNCTIONS ---
         function populateCategories() {
            const select = document.getElementById('category');
            select.innerHTML = '<option value="">Select Category...</option>'; // Clear existing
            CATEGORIES.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });
         }

         function updateTierLimitsDisplay() {
             document.querySelectorAll('.tier-limit').forEach(span => {
                 const tier = span.dataset.tier;
                 let limit = 0;
                 if (tier === '1') limit = TIER_LIMITS.tier1;
                 if (tier === '1-plus') limit = TIER_LIMITS.tier1 + 0.01;
                 if (tier === '2') limit = TIER_LIMITS.tier2;
                 if (tier === '2-plus') limit = TIER_LIMITS.tier2 + 0.01;
                 if (tier === '3') limit = TIER_LIMITS.tier3;
                  span.textContent = limit.toFixed(2); // Display with two decimals
             });
         }


         function renderPendingApprovals(approvals) {
             const listDiv = document.getElementById('approvals-list');
             if (approvals === null) { // Handle explicit error case
                 listDiv.innerHTML = '<p class="text-red-500">Could not load pending approvals.</p>';
                 return;
             }
             if (!approvals || approvals.length === 0) {
                 listDiv.innerHTML = '<p class="text-slate-500">You have no pending approvals.</p>';
                 return;
             }

             // Sort by deadline ascending?
             approvals.sort((a,b) => new Date(a.deadline) - new Date(b.deadline));

             listDiv.innerHTML = approvals.map(req => {
                 const isOverdue = new Date(req.deadline) < new Date();
                 const deadlineClass = isOverdue ? 'text-red-600 font-semibold' : 'text-slate-500';
                 const now = new Date();
                 const submissionDate = new Date(req.submission_date);
                 const daysPending = Math.floor((now - submissionDate) / (1000 * 60 * 60 * 24));
                 const showOverride = USER_PROFILE?.isAdmin && daysPending > 5 && (req.status === 'Pending Admin Approval' || req.status === 'Pending Board Approval');

                 return `
                 <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                     <div class="flex flex-col md:flex-row justify-between md:items-start">
                         <div class="mb-3 md:mb-0 md:mr-4 flex-grow">
                             <h4 class="text-lg font-semibold text-slate-800">${req.id} - ${formatCurrency(req.amount)}</h4>
                             <p class="text-sm text-slate-600">${req.description}</p>
                             <p class="text-xs text-slate-500 mt-1">Submitted by: ${req.submitter} on ${req.date}</p>
                             <p class="text-xs ${deadlineClass} mt-1">Approval Deadline: ${req.deadline} ${isOverdue ? '(Overdue)' : ''}</p>
                             <p class="text-xs text-blue-600 mt-1">Current Status: ${req.status}</p>
                         </div>
                         <div class="flex flex-col space-y-2 md:w-48 flex-shrink-0">
                             <button class="approve-btn text-sm bg-teal-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-teal-700 transition w-full" data-id="${req.id}" data-decision="approved">
                                 <i class="ph-check-circle mr-1"></i> Approve
                             </button>
                             <button class="reject-btn text-sm bg-red-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-red-700 transition w-full" data-id="${req.id}" data-decision="rejected">
                                 <i class="ph-x-circle mr-1"></i> Reject
                             </button>
                              ${showOverride ? `
                              <button class="override-btn text-sm bg-orange-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-orange-600 transition w-full" data-id="${req.id}" data-decision="admin_override">
                                  <i class="ph-warning mr-1"></i> Admin Override
                              </button>
                              ` : ''}
                         </div>
                     </div>
                 </div>
                 `;
             }).join('');
             if (typeof phosphor !== 'undefined') phosphor.replace();
         }

        function renderAdminTasks(tasks) {
            const listDiv = document.getElementById('admin-tasks-list');
             if (tasks === null) { // Handle explicit error case
                 listDiv.innerHTML = '<p class="text-red-500">Could not load admin tasks.</p>';
                 return;
             }
             if (!tasks || tasks.length === 0) {
                 listDiv.innerHTML = '<p class="text-slate-500">No approved requests awaiting payment or recently paid.</p>';
                 return;
             }

            // Separate into pending payment and completed
            const pendingPayment = tasks.filter(t => t.status === 'Approved');
            const completed = tasks.filter(t => t.status === 'Check Issued');

            let html = '';

            if (pendingPayment.length > 0) {
                 html += '<h3 class="text-xl font-semibold text-slate-800 mb-3">Approved - Pending Payment</h3>';
                 html += pendingPayment.map(req => `
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                        <div class="flex flex-col md:flex-row justify-between md:items-start">
                            <div class="mb-3 md:mb-0 md:mr-4 flex-grow">
                                <h4 class="text-lg font-semibold text-slate-800">${req.id} - ${formatCurrency(req.amount)}</h4>
                                <p class="text-sm text-slate-600">${req.description}</p>
                                <p class="text-xs text-slate-500 mt-1">Submitter: ${req.submitter} | Submitted: ${req.date} | Method: ${req.paymentMethod}</p>
                            </div>
                            <div class="flex-shrink-0 md:w-48">
                                <button class="issue-check-btn text-sm bg-blue-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-700 transition w-full" data-id="${req.id}" data-amount="${req.amount}" data-submitter="${req.submitter}">
                                     <i class="ph-money mr-1"></i> Mark as Paid
                                </button>
                            </div>
                        </div>
                    </div>`).join('');
            } else {
                 html += '<h3 class="text-xl font-semibold text-slate-800 mb-3">Approved - Pending Payment</h3>';
                 html += '<p class="text-slate-500 mb-6">No requests are currently awaiting payment.</p>';
            }

            if (completed.length > 0) {
                 html += '<h3 class="text-xl font-semibold text-slate-800 mt-8 mb-3 border-t pt-6">Completed Payments</h3>';
                 html += completed.map(req => `
                     <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 opacity-75">
                         <div class="flex flex-col md:flex-row justify-between md:items-start">
                             <div class="flex-grow">
                                <h4 class="text-md font-semibold text-slate-700">${req.id} - ${formatCurrency(req.amount)}</h4>
                                <p class="text-sm text-slate-500">${req.description}</p>
                                <p class="text-xs text-slate-400 mt-1">Submitter: ${req.submitter} | Submitted: ${req.date} | Method: ${req.paymentMethod}</p>
                             </div>
                             <div class="mt-2 md:mt-0 md:ml-4 flex-shrink-0 text-right">
                                 <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                     <i class="ph-check-circle mr-1"></i> Check Issued ${req.checkId ? `(#${req.checkId})` : ''}
                                 </span>
                             </div>
                         </div>
                     </div>`).join('');
            }

            listDiv.innerHTML = html;
             if (typeof phosphor !== 'undefined') phosphor.replace();
        }

         function renderAnalytics(summary) {
             const contentDiv = document.getElementById('analytics-content');
             if (!summary) {
                 contentDiv.innerHTML = `<p class="text-red-500">Could not load summary data.</p>`;
                 return;
             }

             let categoryHtml = '<p class="text-slate-500">No category data available.</p>';
             if (summary.categorySummary && summary.categorySummary.length > 0) {
                 // Use a table for better alignment on mobile/desktop
                 categoryHtml = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Category</th>
                                    <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Total Spent</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-slate-200 text-sm">`;
                 summary.categorySummary.forEach(cat => {
                     categoryHtml += `
                                <tr>
                                    <td class="px-4 py-2 whitespace-nowrap text-slate-700">${cat.name}</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-slate-700 text-right font-medium">${formatCurrency(cat.total)}</td>
                                </tr>`;
                 });
                 categoryHtml += `
                            </tbody>
                        </table>
                    </div>`;
             }

             let monthlyHtml = '<p class="text-slate-500">No monthly data available.</p>';
             if (summary.monthlySummary && summary.monthlySummary.length > 0) {
                  monthlyHtml = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Month</th>
                                    <th scope="col" class="px-4 py-2 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Requests</th>
                                    <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Total Amount</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-slate-200 text-sm">`;
                 summary.monthlySummary.forEach(month => {
                     monthlyHtml += `
                                <tr>
                                    <td class="px-4 py-2 whitespace-nowrap text-slate-700">${month.month}</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-slate-700 text-center">${month.count}</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-slate-700 text-right font-medium">${formatCurrency(month.totalAmount)}</td>
                                </tr>`;
                 });
                 monthlyHtml += `
                            </tbody>
                        </table>
                    </div>`;
             }


             contentDiv.innerHTML = `
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                     <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 text-center sm:text-left">
                         <h4 class="text-sm font-medium text-slate-500 uppercase">Total Requests</h4>
                         <p class="text-3xl font-bold text-slate-800 mt-1">${summary.totalRequests}</p>
                     </div>
                     <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 text-center sm:text-left">
                         <h4 class="text-sm font-medium text-slate-500 uppercase">Total Approved Spend</h4>
                         <p class="text-3xl font-bold text-slate-800 mt-1">${formatCurrency(summary.totalAmountApproved)}</p>
                     </div>
                     <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 text-center sm:text-left">
                         <h4 class="text-sm font-medium text-slate-500 uppercase">Total Paid Out</h4>
                         <p class="text-3xl font-bold text-slate-800 mt-1">${formatCurrency(summary.totalAmountIssued)}</p>
                     </div>
                </div>

                 <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-800 mb-3">Spending by Category (Approved/Paid)</h3>
                    ${categoryHtml}
                 </div>

                 <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-800 mb-3">Activity by Month (Approved/Paid)</h3>
                     ${monthlyHtml}
                 </div>
             `;

         }

        // --- APPROVAL/ADMIN ACTIONS ---

         function openApprovalModal(requestId, decision) {
             // Fetch basic details from stored USER_PROFILE data
             const approvalItem = USER_PROFILE?.myApprovals?.find(a => a.id === requestId);
             document.getElementById('modal-request-id').textContent = requestId;
             document.getElementById('modal-submitter').textContent = approvalItem?.submitter || 'N/A';
             document.getElementById('modal-amount').textContent = formatCurrency(approvalItem?.amount || 0);
             document.getElementById('modal-description').textContent = approvalItem?.description || 'N/A';

             document.getElementById('approval-comments').value = ''; // Clear comments
              // Store decision and ID for later use
              const modal = document.getElementById('approval-modal');
              modal.dataset.requestId = requestId;

              // Reset buttons and set correct decision target
              const approveBtn = document.getElementById('modal-approve-btn');
              const rejectBtn = document.getElementById('modal-reject-btn');
              approveBtn.textContent = 'Approve';
              approveBtn.dataset.decision = 'approved';
              rejectBtn.classList.remove('hidden');

               if (decision === 'admin_override') {
                   approveBtn.textContent = 'Confirm Override';
                   approveBtn.dataset.decision = 'admin_override'; // Set override decision
                   rejectBtn.classList.add('hidden'); // Hide reject for override
               } else if (decision === 'rejected') {
                    // Pre-setting decision doesn't make sense here as modal has both buttons
               } else { // 'approved' or default case
                    // Already set above
               }


              modal.classList.add('modal-active');
         }

         function closeApprovalModal() {
              document.getElementById('approval-modal').classList.remove('modal-active');
              // Clear stored data
              delete document.getElementById('approval-modal').dataset.requestId;
             // Reset approve button text and visibility of reject button
              document.getElementById('modal-approve-btn').textContent = 'Approve';
              document.getElementById('modal-reject-btn').classList.remove('hidden');

         }

         function handleApprovalAction(event) {
             const button = event.target.closest('button');
             if (!button || button.id === 'modal-cancel-btn') return;

             const finalDecision = button.dataset.decision; // 'approved', 'rejected', or 'admin_override'
             const modal = document.getElementById('approval-modal');
             const requestId = modal.dataset.requestId;
             const comments = document.getElementById('approval-comments').value.trim();

             if (!requestId || !finalDecision) return;

             if (finalDecision === 'rejected' && !comments) {
                 showMessage('error', 'Comments are required for rejection.');
                 return;
             }

             showLoading();
             closeApprovalModal(); // Close modal immediately

             const payload = {
                 action: 'submitApproval',
                 token: ID_TOKEN,
                 requestId: requestId,
                 decision: finalDecision,
                 comments: comments
             };

             fetch(WEB_APP_URL, {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify(payload)
             })
             .then(response => response.json())
             .then(data => {
                 if (data.status === 'success') {
                     showMessage('success', `Request ${requestId} ${finalDecision === 'rejected' ? 'rejected' : 'approved'}.`);
                     fetchApproverData(); // Refresh the list
                      // Also refresh analytics if admin made the change
                      if (USER_PROFILE?.isAdmin) fetchAnalyticsData();
                 } else {
                     throw new Error(data.message || 'Failed to submit decision.');
                 }
             })
             .catch(error => {
                 console.error('Approval Error:', error);
                 showMessage('error', `Could not submit decision: ${error.message}`);
             })
             .finally(() => hideLoading());
         }


         function openCheckIssueModal(requestId, amount, submitter) {
             document.getElementById('check-modal-request-id').textContent = requestId;
             document.getElementById('check-modal-amount').textContent = formatCurrency(amount);
              document.getElementById('check-modal-submitter').textContent = submitter;
             document.getElementById('check-number').value = ''; // Clear previous value
             const modal = document.getElementById('check-issue-modal');
             modal.dataset.requestId = requestId; // Store ID
             modal.classList.add('modal-active');
         }

          function closeCheckIssueModal() {
              document.getElementById('check-issue-modal').classList.remove('modal-active');
               delete document.getElementById('check-issue-modal').dataset.requestId;
          }

          function handleIssueCheck() {
             const modal = document.getElementById('check-issue-modal');
             const requestId = modal.dataset.requestId;
             const checkNumber = document.getElementById('check-number').value.trim();

             if (!requestId) return;

              showLoading();
              closeCheckIssueModal(); // Close modal immediately

              const payload = {
                 action: 'issueCheck',
                 token: ID_TOKEN,
                 requestId: requestId,
                 checkNumber: checkNumber
             };

             fetch(WEB_APP_URL, {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify(payload)
             })
             .then(response => response.json())
             .then(data => {
                 if (data.status === 'success') {
                     showMessage('success', `Request ${requestId} marked as paid.`);
                     fetchApproverData(); // Refresh the admin task list
                      fetchAnalyticsData(); // Refresh analytics
                 } else {
                     throw new Error(data.message || 'Failed to update status.');
                 }
             })
             .catch(error => {
                 console.error('Issue Check Error:', error);
                 showMessage('error', `Could not mark as paid: ${error.message}`);
             })
             .finally(() => hideLoading());
          }


        // --- EVENT LISTENERS ---
        function addEventListeners() {
            // Tab switching
            tabButtons.forEach(button => {
                button.addEventListener('click', () => switchToTab(button.dataset.tab));
            });

            // Form submission
            expenseForm.addEventListener('submit', handleFormSubmit);

             // Amount input changes -> update tier info
            amountInput.addEventListener('input', (e) => {
                updateTierInfo(parseFloat(e.target.value) || 0);
            });

             // Request Type changes -> update form requirements
             requestTypeSelect.addEventListener('change', (e) => {
                  updateFormRequirements(parseInt(tierInput.value) || 0, e.target.value);
             });

             // Approval Modal Interaction
             document.getElementById('approvals-list').addEventListener('click', (event) => {
                 const button = event.target.closest('button.approve-btn, button.reject-btn, button.override-btn');
                 if (button) {
                      event.stopPropagation(); // Prevent potential background clicks
                     openApprovalModal(button.dataset.id, button.dataset.decision);
                 }
             });
             document.getElementById('modal-cancel-btn').addEventListener('click', closeApprovalModal);
             document.getElementById('modal-approve-btn').addEventListener('click', handleApprovalAction);
             document.getElementById('modal-reject-btn').addEventListener('click', handleApprovalAction);
              // Close modal if clicking outside the content
              document.getElementById('approval-modal').addEventListener('click', (event) => {
                 if (event.target === event.currentTarget) { closeApprovalModal(); }
              });


              // Check Issue Modal Interaction
              document.getElementById('admin-tasks-list').addEventListener('click', (event) => {
                 const button = event.target.closest('button.issue-check-btn');
                 if (button) {
                      event.stopPropagation();
                     openCheckIssueModal(button.dataset.id, button.dataset.amount, button.dataset.submitter);
                 }
              });
             document.getElementById('check-modal-cancel-btn').addEventListener('click', closeCheckIssueModal);
             document.getElementById('check-modal-confirm-btn').addEventListener('click', handleIssueCheck);
             // Close modal if clicking outside the content
             document.getElementById('check-issue-modal').addEventListener('click', (event) => {
                 if (event.target === event.currentTarget) { closeCheckIssueModal(); }
              });


        }

        // --- INITIALIZATION ---
        window.onload = function() {
            document.getElementById('current-year').textContent = new Date().getFullYear();
            initializeGoogleSignIn();
            addEventListeners();
            fetchPublicData();
            // Fetch secure data if already logged in (e.g., One Tap) handled by callback
             cleanUrlParams(); // Clean URL on initial load

             // Set initial tab based on login state (handled implicitly by hiding/showing tabs)
             updateLoginUI(false); // Assume logged out initially
             switchToTab('policy'); // Default to policy tab

        };

    </script>
</body>
</html>

