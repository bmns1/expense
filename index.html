<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVA Reimbursement Portal</title>
    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/phosphor-icons"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .tab-btn {
            @apply -mb-px border-b-2 border-transparent px-4 py-3 text-sm font-medium text-slate-500 hover:border-slate-300 hover:text-slate-700;
        }
        .tab-btn.tab-active {
            @apply border-teal-600 text-teal-700;
        }
        .tab-content {
            display: none;
        }
        .tab-content-active {
            display: block;
        }
        /* Custom styles for file input */
        input[type="file"]::file-selector-button {
            @apply mr-3 inline-flex items-center rounded-lg border border-slate-300 bg-slate-50 px-3 py-2 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-100;
        }
    </style>
</head>
<body class="antialiased text-slate-900">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <!-- Logo and Title -->
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <img src="https://raw.githubusercontent.com/bmns1/parent-portal/main/logo.png" alt="SVA Logo" class="h-12 w-auto">
                    </div>
                    <div class="ml-4">
                        <h1 class="text-xl font-bold text-slate-900">SVA Reimbursement Portal</h1>
                        <p class="text-sm text-slate-500">Silicon Valley Academy</p>
                    </div>
                </div>
                <!-- Login/User Info -->
                <div id="auth-container">
                    <!-- This container will be populated by Google Sign-In -->
                </div>
            </div>
        </div>
        <!-- Navigation Tabs -->
        <nav class="bg-white border-b border-slate-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex">
                    <button class="tab-btn tab-active" data-tab="new-request">
                        <i class="ph-plus-circle mr-1.5 align-middle text-base"></i>New Request
                    </button>
                    <!-- These tabs are hidden by default and shown on login -->
                    <button class="tab-btn hidden" data-tab="approvals" id="approvals-tab">
                        <i class="ph-list-checks mr-1.5 align-middle text-base"></i>My Pending Approvals
                    </button>
                    <button class="tab-btn hidden" data-tab="admin" id="admin-tab">
                        <i class="ph-bank mr-1.5 align-middle text-base"></i>Admin Dashboard
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-8 sm:py-10 px-4 sm:px-6 lg:px-8">

        <!-- =================================== -->
        <!-- VIEW 1: New Request (Default)       -->
        <!-- =================================== -->
        <div id="new-request" class="tab-content tab-content-active">
            <div class="max-w-3xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-slate-200">
                <form id="expense-form" class="space-y-6">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900">New Expense Request</h2>
                        <p class="mt-1 text-sm text-slate-600">Submit a reimbursement or pre-approval request. Please fill out all fields.</p>
                    </div>

                    <!-- Submitter Details -->
                    <div class="border-b border-slate-200 pb-6 space-y-4">
                        <h3 class="text-lg font-semibold text-slate-800">1. Submitter Details</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="submitter-name" class="block text-sm font-medium text-slate-700">Full Name</label>
                                <input type="text" id="submitter-name" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" required>
                            </div>
                            <div>
                                <label for="submitter-email" class="block text-sm font-medium text-slate-700">Email Address</label>
                                <input type="email" id="submitter-email" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" required>
                            </div>
                        </div>
                        <div>
                            <label for="submitter-role" class="block text-sm font-medium text-slate-700">Role at SVA (e.g., "Parent", "Teacher", "Admin")</label>
                            <input type="text" id="submitter-role" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" required>
                        </div>
                    </div>
                    
                    <!-- Expense Details -->
                    <div class="border-b border-slate-200 pb-6 space-y-4">
                        <h3 class="text-lg font-semibold text-slate-800">2. Expense Details</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="category" class="block text-sm font-medium text-slate-700">Category</label>
                                <select id="category" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" required>
                                    <option value="">Loading categories...</option>
                                </select>
                            </div>
                            <div>
                                <label for="amount" class="block text-sm font-medium text-slate-700">Total Amount ($)</label>
                                <input type="number" id="amount" step="0.01" min="0.01" placeholder="e.g., 150.75" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" required>
                            </div>
                        </div>
                         <!-- Dynamic Tier Info Box -->
                        <div id="tier-info-box" class="hidden p-4 rounded-lg bg-slate-50 border border-slate-200">
                            <h4 class="font-semibold text-slate-800 flex items-center">
                                <i class="ph-info mr-2 text-blue-500"></i>
                                <span id="tier-title">Tier 1 Request</span>
                            </h4>
                            <p id="tier-description" class="text-sm text-slate-600 mt-1"></p>
                        </div>
                        <!-- Amount Too High Error Box -->
                        <div id="amount-too-high" class="hidden p-4 rounded-lg bg-red-50 border border-red-300">
                            <h4 class="font-semibold text-red-800 flex items-center">
                                <i class="ph-x-circle mr-2"></i>Amount Exceeds Portal Limit
                            </h4>
                            <p id="amount-too-high-desc" class="text-sm text-red-700 mt-1"></p>
                        </div>
                    </div>
                    
                    <!-- Request Type & Vendor -->
                    <div class="border-b border-slate-200 pb-6 space-y-4">
                        <h3 class="text-lg font-semibold text-slate-800">3. Request & Vendor</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="request-type" class="block text-sm font-medium text-slate-700">Request Type</label>
                                <select id="request-type" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" required>
                                    <option value="">Select a type...</option>
                                    <option value="reimbursement">Reimbursement (Paid, need money back)</option>
                                    <option value="pre-approval">Pre-Approval (Not yet paid)</option>
                                </select>
                            </div>
                            <div>
                                <label for="vendor" class="block text-sm font-medium text-slate-700">Vendor / Store Name</label>
                                <input type="text" id="vendor" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" required>
                            </div>
                        </div>
                        <div>
                            <label for="payment-method" class="block text-sm font-medium text-slate-700">Payment Method</label>
                            <select id="payment-method" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" required>
                                <option value="">Select a method...</option>
                                <option value="Personal Account">Personal Account (Check Reimbursement)</option>
                                <option value="School Account">School Account (Direct Payment/P-Card)</option>
                            </select>
                            <p id="payment-method-warning" class="text-sm text-red-600 mt-1 hidden"></p>
                        </div>
                        <div>
                            <label for="description" class="block text-sm font-medium text-slate-700">Brief Description & Justification</label>
                            <textarea id="description" rows="3" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" placeholder="e.g., Art supplies for 3rd grade PTO event..." required></textarea>
                        </div>
                    </div>

                    <!-- File Uploads -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-slate-800">4. File Uploads</h3>
                        <!-- Quote / Invoice (For Pre-Approval) -->
                        <div id="quote-upload-section">
                            <label for="quote" class="block text-sm font-medium text-slate-700">Quote or Invoice <span class="text-slate-500">(Required for Pre-Approval)</span></label>
                            <input type="file" id="quote" class="mt-1 block w-full text-sm text-slate-600">
                        </div>
                        <!-- Receipt (For Reimbursement) -->
                        <div id="receipt-upload-section">
                            <label for="receipt" class="block text-sm font-medium text-slate-700">Receipt <span class="text-slate-500">(Required for Reimbursement)</span></label>
                            <input type="file" id="receipt" class="mt-1 block w-full text-sm text-slate-600">
                        </div>
                        <!-- Pre-Approval Proof (For Tiers 2 & 3 Reimbursement) -->
                        <div id="pre-approval-upload-section" class="hidden">
                            <label for="pre-approval" class="block text-sm font-medium text-slate-700">Proof of Pre-Approval <span class="font-bold text-red-600">(Required)</span></label>
                            <p class="text-xs text-slate-500 mb-1">Please upload the email or document showing you received approval before this purchase.</p>
                            <input type="file" id="pre-approval" class="mt-1 block w-full text-sm text-slate-600">
                        </div>
                    </div>
                    
                    <!-- Submission -->
                    <div class="border-t border-slate-200 pt-6">
                        <button type="submit" id="submit-btn" class="w-full flex items-center justify-center text-lg bg-teal-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-teal-700 transition shadow-sm disabled:bg-slate-400">
                            <i class="ph-paper-plane-tilt mr-2"></i>
                            <span id="submit-btn-text">Submit Request</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- =================================== -->
        <!-- VIEW 2: My Pending Approvals        -->
        <!-- =================================== -->
        <div id="approvals" class="tab-content">
            <h2 class="text-3xl font-bold text-slate-900 mb-6">My Pending Approvals</h2>
            <div id="approvals-list" class="space-y-6">
                <!-- Approval cards will be rendered here by JS -->
            </div>
             <!-- Modal for Approve/Reject -->
            <div id="approval-modal" class="hidden fixed inset-0 bg-slate-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
                <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
                    <h3 class="text-xl font-bold text-slate-900" id="modal-title">Take Action</h3>
                    <p class="text-sm text-slate-500" id="modal-subtitle">For Request ID: <span class="font-medium" id="modal-request-id"></span></p>
                    <div class="mt-4">
                        <label for="modal-comments" class="block text-sm font-medium text-slate-700">Comments (Required for Rejection)</label>
                        <textarea id="modal-comments" rows="3" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" placeholder="e.g., Approved, but please use vendor X next time."></textarea>
                    </div>
                    <div class="mt-6 flex flex-col sm:flex-row-reverse gap-3">
                        <button id="modal-submit-btn" class="w-full sm:w-auto inline-flex justify-center rounded-lg border border-transparent bg-teal-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-teal-700">
                            Submit Decision
                        </button>
                         <button id="modal-cancel-btn" type="button" class="w-full sm:w-auto inline-flex justify-center rounded-lg border border-slate-300 bg-white px-4 py-2 text-base font-medium text-slate-700 shadow-sm hover:bg-slate-50">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- =================================== -->
        <!-- VIEW 3: Admin Dashboard             -->
        <!-- =================================== -->
        <div id="admin" class="tab-content">
            <h2 class="text-3xl font-bold text-slate-900 mb-6">Admin: Issue Payments</h2>
            <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                <div class="p-4 sm:p-6">
                    <h3 class="text-lg font-semibold text-slate-800">Approved, Awaiting Payment</h3>
                    <p class="text-sm text-slate-500 mt-1">These requests have been fully approved and are ready for payment to be issued.</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Submitter</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Details</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Payment Method</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody id="admin-tasks-list" class="bg-white divide-y divide-slate-200">
                            <!-- Admin tasks will be rendered here by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
             <!-- Modal for Issuing Check -->
            <div id="issue-check-modal" class="hidden fixed inset-0 bg-slate-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
                <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
                    <h3 class="text-xl font-bold text-slate-900">Issue Payment</h3>
                    <p class="text-sm text-slate-500" id="issue-modal-subtitle">For Request ID: <span class="font-medium" id="issue-modal-request-id"></span></p>
                    <div class="mt-4">
                        <label for="issue-modal-check-number" class="block text-sm font-medium text-slate-700">Check # or Transaction ID (Optional)</label>
                        <input type="text" id="issue-modal-check-number" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" placeholder="e.g., 45102">
                    </div>
                    <div class="mt-6 flex flex-col sm:flex-row-reverse gap-3">
                        <button id="issue-modal-submit-btn" class="w-full sm:w-auto inline-flex justify-center rounded-lg border border-transparent bg-teal-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-teal-700">
                            Mark as "Check Issued"
                        </button>
                         <button id="issue-modal-cancel-btn" type="button" class="w-full sm:w-auto inline-flex justify-center rounded-lg border border-slate-300 bg-white px-4 py-2 text-base font-medium text-slate-700 shadow-sm hover:bg-slate-50">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Global Message/Error Overlay -->
    <div id="message-overlay" class="hidden fixed inset-0 bg-slate-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 text-center">
            <div id="message-icon" class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                <!-- Icon (e.g., check or x) will be inserted here -->
            </div>
            <h3 class="text-xl font-bold text-slate-900 mt-4" id="message-title">Error</h3>
            <p class="text-slate-600 mt-2" id="message-text">Something went wrong.</p>
            <button id="message-close-btn" class="mt-6 w-full inline-flex justify-center rounded-lg border border-transparent bg-teal-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-teal-700">
                Close
            </button>
        </div>
    </div>


    <script>
        // --- CONFIGURATION ---
        const CLIENT_ID = "14216824305-v19ecsmrhk1muaglrlhjceqjk5oeqr4n.apps.googleusercontent.com";
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzD0IJtgmaKSEXu45UiPdQBMSOgLM4vUPlLHBszKpoidTy1AveJS_rF_z7KK1H9RYe8bg/exec';
        
        // Tier limits (will be fetched from backend)
        let TIER_1_MAX = 200;
        let TIER_2_MAX = 1000;
        let TIER_3_MAX = 5000;

        // Global state
        let CURRENT_USER_TOKEN = null;
        let CURRENT_USER_EMAIL = null;
        let IS_ADMIN = false;

        // Store data from backend
        let myApprovals = [];
        let adminTasks = [];
        
        // --- INITIALIZATION ---
        window.onload = function() {
            // 1. Initialize Google Sign-In
            google.accounts.id.initialize({
                client_id: CLIENT_ID,
                callback: gsiCallback,
                auto_select: true
            });
            
            // 2. Render the "Sign In with Google" button
            google.accounts.id.renderButton(
                document.getElementById('auth-container'),
                { theme: "outline", size: "large", text: "sign_in_with" } 
            );

            // 3. Fetch public data (categories, tiers) for the submission form
            fetchPublicData();

            // 4. Add all global event listeners
            addEventListeners();
        };

        // --- GOOGLE AUTHENTICATION ---
        function gsiCallback(response) {
            CURRENT_USER_TOKEN = response.credential;
            const payload = JSON.parse(atob(CURRENT_USER_TOKEN.split('.')[1]));
            CURRENT_USER_EMAIL = payload.email;

            // Update UI to show user info and Sign Out
            document.getElementById('auth-container').innerHTML = `
                <div class="flex items-center">
                    <div class="text-right mr-3">
                        <div class="text-sm font-medium text-slate-800">${payload.name}</div>
                        <div class="text-xs text-slate-500">${payload.email}</div>
                    </div>
                    <img src="${payload.picture}" alt="Profile" class="h-10 w-10 rounded-full">
                    <button onclick="signOut()" class="ml-4 text-sm font-medium text-slate-600 hover:text-teal-600">Sign Out</button>
                </div>
            `;

            // Fetch secure data for this user
            fetchApproverData();
        }

        function signOut() {
            CURRENT_USER_TOKEN = null;
            CURRENT_USER_EMAIL = null;
            IS_ADMIN = false;
            
            // Clear Google's internal session
            google.accounts.id.disableAutoSelect();

            // Reset UI
            document.getElementById('auth-container').innerHTML = ''; // Clear user info
             google.accounts.id.renderButton( // Re-render sign-in button
                document.getElementById('auth-container'),
                { theme: "outline", size: "large", text: "sign_in_with" } 
            );
            
            // Hide secure tabs and switch to default
            document.getElementById('approvals-tab').classList.add('hidden');
            document.getElementById('admin-tab').classList.add('hidden');
            showView('new-request');

            // Clear secure data
            myApprovals = [];
            adminTasks = [];
            renderApprovals();
            renderAdminTasks();
        }

        // --- DATA FETCHING ---
        function fetchPublicData() {
            showSpinnerOnButton(document.getElementById('submit-btn'), 'Loading Form...', true);
            fetch(`${WEB_APP_URL}?action=getPublicData`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Populate categories
                        const categorySelect = document.getElementById('category');
                        categorySelect.innerHTML = '<option value="">Select a category...</option>';
                        data.categories.forEach(cat => {
                            const option = document.createElement('option');
                            option.value = cat;
                            option.textContent = cat;
                            categorySelect.appendChild(option);
                        });

                        // Set tier limits
                        TIER_1_MAX = parseFloat(data.tierLimits.tier1);
                        TIER_2_MAX = parseFloat(data.tierLimits.tier2);
                        TIER_3_MAX = parseFloat(data.tierLimits.tier3);
                        
                        showSpinnerOnButton(document.getElementById('submit-btn'), 'Submit Request', false);
                    } else {
                        throw new Error(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error fetching public data:', error);
                    showMessage('Error', `Could not load form data: ${error.message}`, 'error');
                    showSpinnerOnButton(document.getElementById('submit-btn'), 'Error Loading', true);
                });
        }

        function fetchApproverData() {
            if (!CURRENT_USER_TOKEN) return;

            // Show loading spinners in secure tabs
            document.getElementById('approvals-list').innerHTML = getSpinnerHtml("Loading your pending approvals...");
            document.getElementById('admin-tasks-list').innerHTML = `<tr><td colspan="4">${getSpinnerHtml("Loading admin tasks...")}</td></tr>`;

            fetch(`${WEB_APP_URL}?action=getApproverData&token=${CURRENT_USER_TOKEN}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        IS_ADMIN = data.isAdmin;
                        myApprovals = data.myApprovals || [];
                        adminTasks = data.adminTasks || [];

                        // Show/Hide tabs based on data
                        if (myApprovals.length > 0) {
                            document.getElementById('approvals-tab').classList.remove('hidden');
                        }
                        if (IS_ADMIN) {
                            document.getElementById('admin-tab').classList.remove('hidden');
                        }
                        
                        // Render data
                        renderApprovals();
                        renderAdminTasks();

                    } else {
                        throw new Error(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error fetching approver data:', error);
                    showMessage('Authentication Error', `Could not load your data. Your session might be invalid. Please try signing out and in again. Error: ${error.message}`, 'error');
                    // Clear loading spinners
                    document.getElementById('approvals-list').innerHTML = getEmptyStateHtml("Error loading approvals.");
                    document.getElementById('admin-tasks-list').innerHTML = `<tr><td colspan="4" class="p-6 text-center text-slate-500">Error loading tasks.</td></tr>`;
                });
        }
        
        // --- FORM SUBMISSION ---
        function handleFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const submitBtn = document.getElementById('submit-btn');
            showSpinnerOnButton(submitBtn, 'Submitting...', true);

            // --- 1. Validate Form Logic ---
            const tierInfo = getTierInfo(parseFloat(document.getElementById('amount').value));
            const requestType = document.getElementById('request-type').value;
            const paymentMethod = document.getElementById('payment-method').value;
            const receiptFile = document.getElementById('receipt').files[0];
            const quoteFile = document.getElementById('quote').files[0];
            const preApprovalFile = document.getElementById('pre-approval').files[0];

            let validationError = null;
            if (tierInfo.tier === 4) validationError = "Amount is too high to submit via portal.";
            if (tierInfo.tier >= 2 && requestType === 'reimbursement' && !preApprovalFile) validationError = "Proof of Pre-Approval file is required for Tier 2/3 reimbursements.";
            if (tierInfo.tier === 3 && paymentMethod === 'Personal Account') validationError = "Tier 3 expenses must use a School Account.";
            if (requestType === 'reimbursement' && !receiptFile) validationError = "A receipt file is required for all reimbursements.";
            if (requestType === 'pre-approval' && !quoteFile) validationError = "A quote/invoice file is required for pre-approvals.";

            if (validationError) {
                showMessage('Submission Error', validationError, 'error');
                showSpinnerOnButton(submitBtn, 'Submit Request', false);
                return;
            }

            // --- 2. Prepare FormData ---
            const formData = new FormData();
            formData.append('action', 'submitRequest');
            formData.append('submitterName', document.getElementById('submitter-name').value);
            formData.append('submitterEmail', document.getElementById('submitter-email').value);
            formData.append('submitterRole', document.getElementById('submitter-role').value);
            formData.append('category', document.getElementById('category').value);
            formData.append('amount', parseFloat(document.getElementById('amount').value));
            formData.append('tier', tierInfo.tier);
            formData.append('requestType', requestType);
            formData.append('paymentMethod', paymentMethod);
            formData.append('vendor', document.getElementById('vendor').value);
            formData.append('description', document.getElementById('description').value);
            
            // Append files
            if (quoteFile) formData.append('quote', quoteFile);
            if (receiptFile) formData.append('receipt', receiptFile);
            if (preApprovalFile) formData.append('preApproval', preApprovalFile);

            // --- 3. Fetch (POST) ---
            fetch(WEB_APP_URL, {
                method: 'POST',
                body: formData
                // No 'Content-Type' header, browser sets it for FormData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showMessage('Submission Successful', `Your request has been submitted. Your Request ID is: ${data.requestId}. You will receive an email confirmation.`, 'success');
                    form.reset();
                    updateTierInfo(); // Reset form UI
                    updateDynamicFormFields(); // Reset dynamic fields
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(error => {
                console.error('Submission error:', error);
                showMessage('Submission Failed', `An error occurred: ${error.message}. Please try again.`, 'error');
            })
            .finally(() => {
                showSpinnerOnButton(submitBtn, 'Submit Request', false);
            });
        }
        
        // --- APPROVAL & ADMIN ACTIONS ---

        function handleApprovalAction(requestId, decision, comments) {
            if (!CURRENT_USER_TOKEN) {
                showMessage('Error', 'You must be logged in to take action.', 'error');
                return;
            }
            
            const modalSubmitBtn = document.getElementById('modal-submit-btn');
            showSpinnerOnButton(modalSubmitBtn, 'Submitting...', true);

            fetch(WEB_APP_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'submitApproval',
                    token: CURRENT_USER_TOKEN,
                    requestId: requestId,
                    decision: decision,
                    comments: comments
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showMessage('Action Recorded', `Your decision for ${requestId} has been recorded.`, 'success');
                    closeApprovalModal();
                    fetchApproverData(); // Refresh list
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(error => {
                console.error('Approval error:', error);
                showMessage('Error', `Could not record decision: ${error.message}`, 'error');
            })
            .finally(() => {
                showSpinnerOnButton(modalSubmitBtn, 'Submit Decision', false);
            });
        }
        
        function handleIssueCheck(requestId, checkNumber) {
            if (!CURRENT_USER_TOKEN || !IS_ADMIN) {
                showMessage('Error', 'You must be logged in as an admin.', 'error');
                return;
            }
            
            const modalSubmitBtn = document.getElementById('issue-modal-submit-btn');
            showSpinnerOnButton(modalSubmitBtn, 'Processing...', true);

            fetch(WEB_APP_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'issueCheck',
                    token: CURRENT_USER_TOKEN,
                    requestId: requestId,
                    checkNumber: checkNumber
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showMessage('Payment Recorded', `Request ${requestId} has been marked as "Check Issued".`, 'success');
                    closeIssueCheckModal();
                    fetchApproverData(); // Refresh admin list
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(error => {
                console.error('Issue check error:', error);
                showMessage('Error', `Could not update status: ${error.message}`, 'error');
            })
            .finally(() => {
                showSpinnerOnButton(modalSubmitBtn, 'Mark as "Check Issued"', false);
            });
        }


        // --- DYNAMIC FORM UI ---
        function getTierInfo(amount) {
            if (isNaN(amount) || amount <= 0) return { tier: 0, title: '', description: '' };
            if (amount <= TIER_1_MAX) return {
                tier: 1,
                title: 'Tier 1 Request',
                description: 'No prior approval needed. Personal accounts can be used for payment.'
            };
            if (amount <= TIER_2_MAX) return {
                tier: 2,
                title: 'Tier 2 Request',
                description: 'Requires School Admin approval BEFORE purchase. Personal or school account can be used.'
            };
            if (amount <= TIER_3_MAX) return {
                tier: 3,
                title: 'Tier 3 Request',
                description: 'Requires Admin AND Board approval BEFORE purchase. Must use School Account for payment.'
            };
            return {
                tier: 4, // Too high
                title: 'Amount Exceeds Portal Limit',
                description: `Expenses over $${TIER_3_MAX} cannot be submitted via this portal. Please email <a href="mailto:bod@svamail.com" class="font-medium text-red-800 underline">bod@svamail.com</a> directly with details.`
            };
        }

        function updateTierInfo() {
            const amount = parseFloat(document.getElementById('amount').value);
            const tierInfo = getTierInfo(amount);
            const infoBox = document.getElementById('tier-info-box');
            const errorBox = document.getElementById('amount-too-high');
            const submitBtn = document.getElementById('submit-btn');

            if (tierInfo.tier === 0) {
                infoBox.classList.add('hidden');
                errorBox.classList.add('hidden');
                submitBtn.disabled = false;
            } else if (tierInfo.tier === 4) {
                infoBox.classList.add('hidden');
                errorBox.classList.remove('hidden');
                document.getElementById('amount-too-high-desc').innerHTML = tierInfo.description;
                submitBtn.disabled = true;
            } else {
                errorBox.classList.add('hidden');
                infoBox.classList.remove('hidden');
                document.getElementById('tier-title').textContent = tierInfo.title;
                document.getElementById('tier-description').textContent = tierInfo.description;
                submitBtn.disabled = false;
            }
            updateDynamicFormFields();
        }

        function updateDynamicFormFields() {
            const amount = parseFloat(document.getElementById('amount').value);
            const tierInfo = getTierInfo(amount);
            const requestType = document.getElementById('request-type').value;

            const paymentMethodSelect = document.getElementById('payment-method');
            const paymentWarning = document.getElementById('payment-method-warning');
            const preApprovalUpload = document.getElementById('pre-approval-upload-section');
            const receiptUpload = document.getElementById('receipt-upload-section');
            const quoteUpload = document.getElementById('quote-upload-section');

            // Rule 1: Tier 3 must use School Account
            if (tierInfo.tier === 3) {
                paymentMethodSelect.value = 'School Account';
                paymentMethodSelect.disabled = true;
                paymentWarning.textContent = 'Tier 3 requests must use the School Account.';
                paymentWarning.classList.remove('hidden');
            } else {
                paymentMethodSelect.disabled = false;
                paymentWarning.classList.add('hidden');
                if (paymentMethodSelect.value === 'School Account' && tierInfo.tier < 3) {
                    paymentMethodSelect.value = ''; // Reset if tier drops
                }
            }

            // Rule 2: Show correct file upload fields based on Request Type
            if (requestType === 'reimbursement') {
                receiptUpload.classList.remove('hidden');
                quoteUpload.classList.add('hidden');
            } else if (requestType === 'pre-approval') {
                receiptUpload.classList.add('hidden');
                quoteUpload.classList.remove('hidden');
            } else {
                receiptUpload.classList.add('hidden');
                quoteUpload.classList.add('hidden');
            }

            // Rule 3: Tier 2/3 reimbursements require pre-approval proof
            if (tierInfo.tier >= 2 && requestType === 'reimbursement') {
                preApprovalUpload.classList.remove('hidden');
            } else {
                preApprovalUpload.classList.add('hidden');
            }
        }
        
        // --- RENDERING FUNCTIONS ---
        function renderApprovals() {
            const list = document.getElementById('approvals-list');
            if (myApprovals.length === 0) {
                list.innerHTML = getEmptyStateHtml("You have no pending approvals.");
                return;
            }

            list.innerHTML = myApprovals.map(req => {
                const now = new Date();
                const submissionDate = new Date(req.submission_date);
                const daysElapsed = (now - submissionDate) / (1000 * 60 * 60 * 24);
                let timeoutWarning = '';
                let overrideButton = '';

                if (daysElapsed > 5) {
                    timeoutWarning = `<div class="mt-2 text-sm font-medium text-red-600"><i class="ph-warning-circle align-middle mr-1"></i> This request is ${Math.floor(daysElapsed)} days old (over 5-day limit).</div>`;
                    if (IS_ADMIN) {
                        overrideButton = `<button class="action-btn-override w-full sm:w-auto bg-yellow-100 text-yellow-800 hover:bg-yellow-200" data-id="${req.id}" data-desc="${req.description}">
                                            <i class="ph-warning-diamond mr-1.5"></i> Admin Override
                                        </button>`;
                    }
                }
                
                return `
                <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                    <div class="p-5 sm:p-6">
                        <div class="flex flex-col sm:flex-row justify-between sm:items-start">
                            <div>
                                <h3 class="text-xl font-bold text-slate-800">$${req.amount.toFixed(2)} - ${req.description}</h3>
                                <p class="text-sm text-slate-500 mt-1">
                                    Submitted by <span class="font-medium">${req.submitter}</span> on ${req.date}
                                </p>
                                <div class="mt-2 text-sm">
                                    <span class="inline-flex items-center rounded-full bg-blue-100 px-3 py-0.5 text-xs font-medium text-blue-800">Tier ${req.tier}</span>
                                    <span class="inline-flex items-center rounded-full bg-gray-100 px-3 py-0.5 text-xs font-medium text-gray-800 ml-2">${req.status}</span>
                                </div>
                                ${timeoutWarning}
                            </div>
                            <div class="mt-4 sm:mt-0 sm:ml-6 sm:text-right flex-shrink-0">
                                <p class="text-sm font-medium text-slate-600">Request ID</p>
                                <p class="text-lg font-mono text-slate-900">${req.id}</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-50 px-5 py-4 border-t border-slate-200">
                        <div class="flex flex-col sm:flex-row gap-3">
                            <button class="action-btn-approve w-full sm:w-auto bg-teal-600 text-white hover:bg-teal-700" data-id="${req.id}" data-desc="${req.description}">
                                <i class="ph-check-circle mr-1.5"></i> Approve
                            </button>
                            <button class="action-btn-reject w-full sm:w-auto bg-red-600 text-white hover:bg-red-700" data-id="${req.id}" data-desc="${req.description}">
                                <i class="ph-x-circle mr-1.5"></i> Reject
                            </button>
                            ${overrideButton}
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderAdminTasks() {
            const list = document.getElementById('admin-tasks-list');
            if (adminTasks.length === 0) {
                list.innerHTML = `<tr><td colspan="4" class="p-6 text-center text-slate-500">No requests are pending payment.</td></tr>`;
                return;
            }

            list.innerHTML = adminTasks.map(task => `
                <tr class="hover:bg-slate-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-slate-900">${task.submitter}</div>
                        <div class="text-xs text-slate-500">${task.id}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-slate-900">$${task.amount.toFixed(2)}</div>
                        <div class="text-xs text-slate-500 truncate" style="max-width: 200px;">${task.description}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center rounded-full px-3 py-0.5 text-xs font-medium ${task.paymentMethod === 'School Account' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                            ${task.paymentMethod}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button class="action-btn-issue-check inline-flex items-center rounded-lg bg-teal-600 px-3 py-2 text-sm font-medium text-white shadow-sm hover:bg-teal-700" data-id="${task.id}">
                            <i class="ph-check-fat mr-1.5"></i> Issue Payment
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // --- MODAL & UI HELPERS ---
        function showView(viewId) {
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('tab-content-active');
            });
            // Deactivate all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active');
            });

            // Show the selected tab content
            document.getElementById(viewId).classList.add('tab-content-active');
            // Activate the selected tab button
            document.querySelector(`.tab-btn[data-tab="${viewId}"]`).classList.add('tab-active');
            
            // Don't modify history, to keep auth tokens in URL clean
        }
        
        function openApprovalModal(requestId, description, decision) {
            const modal = document.getElementById('approval-modal');
            const modalSubmitBtn = document.getElementById('modal-submit-btn');
            const commentsField = document.getElementById('modal-comments');
            
            document.getElementById('modal-request-id').textContent = requestId;
            commentsField.value = ''; // Clear comments
            
            if (decision === 'approved' || decision === 'admin_override') {
                document.getElementById('modal-title').textContent = 'Approve Request';
                document.getElementById('modal-subtitle').textContent = `For Request ID: ${requestId}`;
                modalSubmitBtn.className = "w-full sm:w-auto inline-flex justify-center rounded-lg border border-transparent bg-teal-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-teal-700";
                modalSubmitBtn.innerHTML = 'Submit Approval';
                commentsField.placeholder = 'Optional comments for approval...';
                if (decision === 'admin_override') {
                     document.getElementById('modal-title').textContent = 'Admin Override Approval';
                     commentsField.value = 'Admin Override (5-day rule): ';
                }
            } else { // 'rejected'
                document.getElementById('modal-title').textContent = 'Reject Request';
                document.getElementById('modal-subtitle').textContent = `For Request ID: ${requestId}`;
                modalSubmitBtn.className = "w-full sm:w-auto inline-flex justify-center rounded-lg border border-transparent bg-red-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-red-700";
                modalSubmitBtn.innerHTML = 'Submit Rejection';
                commentsField.placeholder = 'Rejection reason is required...';
            }
            
            // Set data attributes for the submit button
            modalSubmitBtn.dataset.id = requestId;
            modalSubmitBtn.dataset.decision = decision;
            
            modal.classList.remove('hidden');
        }

        function closeApprovalModal() {
            document.getElementById('approval-modal').classList.add('hidden');
        }
        
        function openIssueCheckModal(requestId) {
            const modal = document.getElementById('issue-check-modal');
            document.getElementById('issue-modal-request-id').textContent = requestId;
            document.getElementById('issue-modal-check-number').value = '';
            document.getElementById('issue-modal-submit-btn').dataset.id = requestId;
            modal.classList.remove('hidden');
        }
        
        function closeIssueCheckModal() {
            document.getElementById('issue-check-modal').classList.add('hidden');
        }

        function showMessage(title, text, type = 'error') {
            const overlay = document.getElementById('message-overlay');
            const iconContainer = document.getElementById('message-icon');
            const titleEl = document.getElementById('message-title');
            const textEl = document.getElementById('message-text');

            titleEl.textContent = title;
            textEl.innerHTML = text; // Use innerHTML to allow links

            if (type === 'success') {
                iconContainer.className = 'mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-100';
                iconContainer.innerHTML = '<i class="ph-check text-2xl text-green-600"></i>';
            } else { // error
                iconContainer.className = 'mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100';
                iconContainer.innerHTML = '<i class="ph-x text-2xl text-red-600"></i>';
            }
            overlay.classList.remove('hidden');
        }
        
        function getSpinnerHtml(message) {
            return `
            <div class="py-6 text-center text-sm text-slate-500">
                <i class="ph-spinner-gap text-2xl animate-spin text-teal-600"></i>
                <p class="mt-2">${message}</p>
            </div>`;
        }

        function getEmptyStateHtml(message) {
            return `
            <div class="py-6 text-center text-sm text-slate-500 border-2 border-dashed border-slate-200 rounded-lg">
                <i class="ph-folder-simple text-3xl text-slate-400"></i>
                <p class="mt-2 font-medium">${message}</p>
            </div>`;
        }
        
        function showSpinnerOnButton(button, text, isLoading) {
            if (!button) return;
            button.disabled = isLoading;
            if (isLoading) {
                button.innerHTML = `
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    ${text}
                `;
            } else {
                // Restore original text (this is a bit simplified)
                if(button.id === 'submit-btn') button.innerHTML = `<i class="ph-paper-plane-tilt mr-2"></i> ${text}`;
                else button.textContent = text;
            }
        }
        
        // --- GLOBAL EVENT LISTENERS ---
        function addEventListeners() {
            // Tab navigation
            document.querySelector('nav').addEventListener('click', (e) => {
                if (e.target.matches('.tab-btn')) {
                    showView(e.target.dataset.tab);
                }
            });

            // Submission form
            document.getElementById('expense-form').addEventListener('submit', handleFormSubmit);
            document.getElementById('amount').addEventListener('input', updateTierInfo);
            document.getElementById('request-type').addEventListener('change', updateDynamicFormFields);

            // Message overlay close
            document.getElementById('message-close-btn').addEventListener('click', () => {
                document.getElementById('message-overlay').classList.add('hidden');
            });
            
            // Approval Modal
            document.getElementById('approvals-list').addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                const id = button.dataset.id;
                const desc = button.dataset.desc;

                if (button.classList.contains('action-btn-approve')) {
                    openApprovalModal(id, desc, 'approved');
                } else if (button.classList.contains('action-btn-reject')) {
                    openApprovalModal(id, desc, 'rejected');
                } else if (button.classList.contains('action-btn-override')) {
                    openApprovalModal(id, desc, 'admin_override');
                }
            });

            document.getElementById('modal-submit-btn').addEventListener('click', (e) => {
                const btn = e.target;
                const id = btn.dataset.id;
                const decision = btn.dataset.decision;
                const comments = document.getElementById('modal-comments').value;

                if (decision === 'rejected' && !comments) {
                    showMessage('Error', 'Comments are required when rejecting a request.', 'error');
                    return;
                }
                handleApprovalAction(id, decision, comments);
            });
            
            document.getElementById('modal-cancel-btn').addEventListener('click', closeApprovalModal);

            // Issue Check Modal
            document.getElementById('admin-tasks-list').addEventListener('click', (e) => {
                const button = e.target.closest('button.action-btn-issue-check');
                if (button) {
                    openIssueCheckModal(button.dataset.id);
                }
            });
            
            document.getElementById('issue-modal-submit-btn').addEventListener('click', (e) => {
                const id = e.target.dataset.id;
                const checkNumber = document.getElementById('issue-modal-check-number').value;
                handleIssueCheck(id, checkNumber);
            });
            
            document.getElementById('issue-modal-cancel-btn').addEventListener('click', closeIssueCheckModal);
        }

    </script>
</body>
</html>

